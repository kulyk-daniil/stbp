## Лабораторна робота № 8 TIME-BASED ONE TIME PASSWORD

Виконав:
студент гр. КН-Н922б
Кулик Д.І.

Перевірив:
Бульба С.С.

## Мета
Дослідити і реалізувати механізм генерації одноразових паролів TOTP.

## Завдання
Time-based One Time Password. Створити програму, що демонструє роботу розробленого алгоритму. Організувати взаємодію з мобільним додатком Google Authenticator.

## Хід роботи
TOTP означає Time-based One-Time Passwords і є поширеною формою двофакторної автентифікації (2FA). Унікальні цифрові паролі генеруються за стандартизованим алгоритмом, який використовує поточний час як вхідні дані. Паролі на основі часу доступні в автономному режимі та забезпечують зручність і підвищену безпеку облікового запису, якщо використовувати їх як другий фактор.
Для реалізації двофакторної аутентифікації з використанням TOTP необхідно враховувати основну вимогу – пароль повинен створюватись на стороні користувача, а також постійно змінюватись.
Вирішення цього завдання може виглядати так:
Коли користувач включає двофакторну автентифікацію, відбувається таке
• Внутрішній сервер створює секретний ключ для цього користувача
• Потім сервер передає цей секретний ключ до телефонної програми користувача
• Телефонний додаток ініціалізує лічильник
• Телефонний додаток генерує одноразовий пароль, використовуючи цей секретний ключ та лічильник
• Телефонний додаток змінює лічильник через певний інтервал і відновлює одноразовий пароль, роблячи його динамічним.
Однак, у цій послідовності дій є кілька проблем. Перша з них полягає в тому, як програма буде генерувати одноразовий пароль. З цією проблемою справляється попередник методу TOTP – алгоритм HOTP.
HOTP перекладається як "Одноразовий пароль на основі HMAC". Цей алгоритм опубліковано інженерною групою Інтернету (IETF) як RFC4226. HOTP визначає алгоритм створення одноразового пароля із секретного ключа та лічильника.

## Важливі фрагменти програми
Реалізоване оновлення TOTP
```python
def task():
    """Функція створює одноразовий пароль на стороні користувача,
    що записується в файл. Функція емулює пристрій клієнта"""
    log.debug('Generating TOTP...')
    totp = get_totp_token(config.SECRET)
    write_to_file(totp, config.FILENAME)
    log.debug(f'Wrote new TOTP [{totp}] to file.')


def set_background_update():
    """Функція створює одноразовий пароль на стороні користувача,
    що змінюється через певний проміжок часу (30 секунд)
    Через 30 секунд попередній код стає невалідним"""
    scheduler = BackgroundScheduler()
    job = scheduler.add_job(task, 'interval', seconds=config.INTERVAL)
    job.func()
    scheduler.start()
```
Генерація TOTP
```python
def get_hotp_token(secret, intervals_no):
    """Фукнція визначає алгоритм створення одноразового пароля
    із секретного ключа та лічильника на основі HMAC"""
    key = base64.b32decode(secret, True)
    msg = struct.pack(">Q", intervals_no)
    h = hmac.new(key, msg, hashlib.sha1).digest()
    o = o = h[19] & 15
    h = (struct.unpack(">I", h[o:o + 4])[0] & 0x7fffffff) % 1000000
    return h


def get_totp_token(secret):
    """Функція, що генерує одноразовий пароль із шести символів
    за допомогою алгоритма HOTP"""
    x = str(get_hotp_token(secret, intervals_no=int(time.time()) // INTERVAL))
    while len(x) != 6:
        x += '0'
    return x
```
Перевірка на TOTP
```python
if __name__ == '__main__':
    set_background_update()
    login()
    entered_code = enter_code()
    while not validate(entered_code):
        entered_code = input('Невірний код! Спробуйте ще раз:\n')
    print('Авторизація пройшла успішно!')
```
Вміст файлу config.py

![Вміст confіg](/lab08/doc/config_code.png)

## Результати роботи програми

Результат виконання програми

![Результат](/lab08/doc/result.png)

Вміст файлу password.txt

![Вміст password](/lab08/doc/password.png)

Вміст файлу log.file

![Вміст log](/lab08/doc/log.png)

## Висновки
В результаті виконання лабораторної роботи було досліджено і реалізувано механізм генерації одноразових паролів TOTP.